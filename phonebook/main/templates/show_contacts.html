{% extends 'index.html' %}
{% block content %}
{% load crispy_forms_tags %}
<div class="mt-3 mb-3 d-flex justify-content-between mx-3">
    <input type="text" id="search-query" onkeyup="searchContact()"
           class="form-control form-control-primary small-text-input" placeholder="Поиск контактов">
    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#filter">Фильтр</button>
</div>

<div class="modal fade" id="filter" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterLabel">Фильтр</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body">
                <form method="post" id="filterForm">
                    {% csrf_token %}
                    {{ filter_form|crispy}}
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" id="submitFilterButton" name="filter_form_submit">Показать
                    выбранные</выбранные></button>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function () {
        $("#submitFilterButton").click(function () {
            $("#filterForm").submit();
        });
    });
</script>
<table id="all-contacts" class="table table-primary">
    <thead>
    <tr class="header">
        <th class="text-center">ID</th>
        <th class="text-center">Фамилия</th>
        <th class="text-center">Имя</th>
        <th class="text-center">Отчество</th>
        <th class="text-center">Улица</th>
        <th class="text-center">Дом</th>
        <th class="text-center">Корпус</th>
        <th class="text-center">Квартира</th>
        <th class="text-center">Телефон</th>
        <th class="text-center" colspan="2">Действия</th>
    </tr>
    </thead>
    <tbody>
    {% for row in table %}
    <tr>
        {% for column in row %}
        {% if column is None %}
        <td class="text-center">Не указано</td>
        {% else %}
        <td class="text-center">{{ column }}</td>
        {% endif %}
        {% endfor %}
        <td class="text-center"><a href="edit_contact/{{ row.0 }}"><i class="fas fa-edit"></i></a></td>
        <td class="text-center"><a href="delete/{{ row.0 }}"><i class="fas fa-trash"></i></a></td>
    </tr>
    {% endfor %}
    </tbody>
</table>
<div class="mt-3 mx-3">
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#myModal">Добавить</button>
</div>

<!-- Модальное окно -->
<div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="myModalLabel">Добавление контакта</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body">
                <form method="post" id="myForm" class="needs-validation" novalidate>
                    {% csrf_token %}
                    {{ add_form|crispy }}
                </form>
                <datalist id="street-examples">
                    {% for tuple in all_street %}
                    <option value="{{ tuple.0 }}"></option>
                    {% endfor %}}
                </datalist>


                <datalist id="patronymic-examples" class="custom-datalist">
                    {% for tuple in all_patronymic %}
                    <option value="{{ tuple.0 }}"></option>
                    {% endfor %}}
                </datalist>

                <datalist id="first-name-examples" class="custom-datalist">
                    {% for tuple in all_first_name %}
                    <option value="{{ tuple.0 }}"></option>
                    {% endfor %}}
                </datalist>

                <datalist id="last-name-examples" class="custom-datalist">
                    {% for tuple in all_last_name %}
                    <option value="{{ tuple.0 }}"></option>
                    {% endfor %}}
                </datalist>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" id="submitFormButton" name="new_contact_form_submit">
                    Сохранить
                </button>
            </div>
        </div>
    </div>
</div>
<script>
    $(document).ready(function () {
        $("#submitFormButton").click(function () {
            $("#myForm").submit();
        });
    });
</script>
<script>
    function searchContact() {
        // Declare variables
        let input, filter, table, tr, td1, td2, td8, i;
        input = document.getElementById("search-query");
        filter = input.value.toUpperCase();
        table = document.getElementById("all-contacts");
        tr = table.getElementsByTagName("tr");

        // Loop through all table rows, and hide those that don't match the search query
        for (i = 0; i < tr.length; i++) {
            td1 = tr[i].getElementsByTagName("td")[1];
            td2 = tr[i].getElementsByTagName("td")[2];
            td8 = tr[i].getElementsByTagName("td")[8];

            if (td1 || td2 || td8) {
                let found = false;
                if (td1 && td1.innerHTML.toUpperCase().indexOf(filter) > -1) {
                    found = true;
                }
                if (td2 && td2.innerHTML.toUpperCase().indexOf(filter) > -1) {
                    found = true;
                }
                if (td8 && td8.innerHTML.toUpperCase().indexOf(filter) > -1) {
                    found = true;
                }

                if (found) {
                    tr[i].style.display = "";
                } else {
                    tr[i].style.display = "none";
                }
            }
        }
    }
</script>
{% endblock %}